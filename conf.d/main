#!/bin/bash -ex

DOMAIN=www.example.com
ADMIN_EMAIL=admin@example.com
ADMIN_PASS=Turnkey1
APP_NAME="TurnKey GitLab"
DISPLAY_NAME="$APP_NAME Admin"
CONF=/etc/gitlab/gitlab.rb

apt-get update

EXTERNAL_URL="http://gitlab.example.com" apt-get install gitlab-ce -y

# tweak GitLab defaults for build within TKLDev
sed -i "/^external_url/ s|'.*|'http://$DOMAIN'|" $CONF
sed -i "/postgresql\['dynamic_shared_memory_type'\]/ s|^# *||" $CONF
sed -i "/postgresql\['dynamic_shared_memory_type'\]/ s|=.*|= 'none'|" $CONF
sed -i "/postgresql\['shared_buffers'\]/ s|^# *||" $CONF
sed -i "/postgresql\['shared_buffers'\]/ s|=.*|= \"100MB\"|" $CONF

# tweak GitLab email config
sed -i "/gitlab_rails\['gitlab_email_enabled'\]/ s|^# *||" $CONF
sed -i "/gitlab_rails\['gitlab_email_from'\]/ s|^# *||" $CONF
sed -i "/gitlab_rails\['gitlab_email_from'\]/ s|=.*|= '$ADMIN_EMAIL'|" $CONF
sed -i "/gitlab_rails\['gitlab_email_display_name'\]/ s|^# *||" $CONF
sed -i "/gitlab_rails\['gitlab_email_display_name'\]/ s|=.*|= '$DISPLAY_NAME'|" $CONF
sed -i "/gitlab_rails\['gitlab_email_subject_suffix'\]/ s|^# *||" $CONF
sed -i "/gitlab_rails\['gitlab_email_subject_suffix'\]/ s|=.*|= '\[$APP_NAME\]'|" $CONF

# set up GitLab
gitlab-ctl reconfigure

# disable GitLab WebUI prompting to set 'root' GitLab user password (TurnKey
# sets GitLab 'root' user password via inithook)
gitlab-psql -c "UPDATE users SET password_automatically_set='f' WHERE id = 1;"
gitlab-psql -c "UPDATE users SET reset_password_token='' WHERE id = 1;"

gitlab-ctl stop

# remove initially created files which will be auto-regenerated on new host
rm -f /opt/gitlab/embedded/nodes/tkldev.json
rm -f /etc/gitlab/gitlab-secrets.json

# reset GitLab Postgres defaults
sed -i "/postgresql\['dynamic_shared_memory_type'\]/ s|^|# |" $CONF
sed -i "/postgresql\['dynamic_shared_memory_type'\]/ s|= 'none'|= nil|" $CONF
sed -i "/postgresql\['shared_buffers'\]/ s|^|# |" $CONF
sed -i "/postgresql\['shared_buffers'\]/ s|=.*|= \"256MB\"|" $CONF
